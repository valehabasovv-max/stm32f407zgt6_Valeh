# ADC Probleminin Həlli - Sistem Axını

## 🔄 Sistem Başlanğıcı və Diaqnostika

```
┌─────────────────────────────────────────────────────────────────┐
│                    STM32 BAŞLANĞICI                            │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  HAL_Init() → SystemClock_Config() → Peripheral Init           │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                     ADC3 BAŞLATMA                               │
│  - Continuous Mode: ENABLE                                      │
│  - Sampling Time: 480 cycles                                    │
│  - HAL_ADC_Start(&hadc3)                                        │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│               🔍 AVTOMATIK DİAQNOSTİKA BAŞLAYIR                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  1. ADC State Yoxlaması                                  │ │
│  │     - Ready?       [✓ YES]                               │ │
│  │     - Busy?        [  NO ]                               │ │
│  │     - EOC Flag?    [✓ SET]                               │ │
│  │     - OVR Flag?    [  CLR]                               │ │
│  └──────────────────────────────────────────────────────────┘ │
│                            ↓                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  2. Raw ADC Oxuma (10 dəfə)                              │ │
│  │     Read 1: 632                                          │ │
│  │     Read 2: 632   ← Eyni                                 │ │
│  │     Read 3: 632   ← Eyni                                 │ │
│  │     ...                                                   │ │
│  │     Read 10: 632  ← Eyni                                 │ │
│  └──────────────────────────────────────────────────────────┘ │
│                            ↓                                    │
│                    [Dəyişir?]                                   │
│                    /        \                                   │
│              [BƏLİ]         [XEYR]                              │
│                 ↓              ↓                                │
│          ┌───────────┐   ┌──────────────────┐                 │
│          │  NORMAL   │   │  PROBLEM VAR!    │                 │
│          │  İŞLƏYİR  │   │  Addım 3-ə keç   │                 │
│          └───────────┘   └──────────────────┘                 │
│                                  ↓                              │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  3. Kalibrasiya Yoxlaması                                │ │
│  │     ADC Range: 620 - 4095        [✓]                     │ │
│  │     Pressure Range: 0 - 300 bar  [✓]                     │ │
│  │     Slope: 0.086330              [✓]                     │ │
│  │     Offset: -53.52               [✓]                     │ │
│  └──────────────────────────────────────────────────────────┘ │
│                            ↓                                    │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  4. Təzyiq Konversiya Test                               │ │
│  │     ADC=632 → Pressure=?                                 │ │
│  │     Formula: P = -53.52 + (632 × 0.0864)                 │ │
│  │     Result: P = 1.04 bar                                 │ │
│  └──────────────────────────────────────────────────────────┘ │
│                            ↓                                    │
│                    [Pressure = 0.00?]                           │
│                    /              \                             │
│              [XEYR]               [BƏLİ]                        │
│                 ↓                    ↓                          │
│          ┌───────────┐      ┌────────────────────┐            │
│          │  ✓ OK     │      │  ⚠ KALİBRASİYA    │            │
│          │           │      │    PROBLEMİ        │            │
│          └───────────┘      └────────────────────┘            │
│                                      ↓                          │
│              ┌─────────────────────────────────────────────┐  │
│              │  ADC_ForceRecalibration()                   │  │
│              │  - Default dəyərlər təyin et                │  │
│              │  - Flash-a yaz                              │  │
│              │  - Yenidən yoxla                            │  │
│              └─────────────────────────────────────────────┘  │
│                                      ↓                          │
│                           [✓ Düzəldi]                           │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│                    PID SİSTEMİ BAŞLAYIR                         │
│  - AdvancedPressureControl_Init()                               │
│  - Timer 6 interrupt (10ms) başlayır                            │
└─────────────────────────────────────────────────────────────────┘
                            ↓
                    [Main Loop]
```

## 🔁 Runtime ADC Stuck Detection (Main Loop)

```
┌─────────────────────────────────────────────────────────────────┐
│              TIMER 6 INTERRUPT (Hər 10ms)                       │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  AdvancedPressureControl_Step()                                 │
│    ↓                                                            │
│  AdvancedPressureControl_ReadADC()                              │
└─────────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │   ADC Oxundu: adc_value = ?           │
        └───────────────────────────────────────┘
                            ↓
              [adc_value == last_read_value?]
                    /              \
              [XEYR]                [BƏLİ]
                 ↓                     ↓
        ┌────────────────┐   ┌──────────────────────────┐
        │  same_value    │   │  same_value_count++      │
        │  _count = 0    │   └──────────────────────────┘
        └────────────────┘              ↓
                                 [same_value_count > 100?]
                                    /              \
                              [XEYR]                [BƏLİ]
                                 ↓                     ↓
                        ┌─────────────┐    ┌──────────────────────┐
                        │  Davam et   │    │  WARNING mesajı      │
                        └─────────────┘    │  "ADC unchanged      │
                                           │   for X reads"       │
                                           └──────────────────────┘
                                                      ↓
                                           [same_value_count > 500?]
                                                /            \
                                          [XEYR]              [BƏLİ]
                                             ↓                   ↓
                                    ┌──────────────┐   ┌─────────────────────┐
                                    │  Gözlə       │   │ CRITICAL mesajı     │
                                    └──────────────┘   │ "ADC stuck -        │
                                                       │  RESTARTING!"       │
                                                       └─────────────────────┘
                                                                  ↓
                                                   ┌──────────────────────────┐
                                                   │  HAL_ADC_Stop(&hadc3)    │
                                                   │  HAL_Delay(10)           │
                                                   │  HAL_ADC_Start(&hadc3)   │
                                                   │  HAL_Delay(20)           │
                                                   │  same_value_count = 0    │
                                                   └──────────────────────────┘
                                                                  ↓
                                                        [✓ ADC Restart]
                                                                  ↓
                                                        ┌──────────────────┐
                                                        │  INFO mesajı     │
                                                        │  "ADC restarted  │
                                                        │   successfully"  │
                                                        └──────────────────┘
                                                                  ↓
                                                   [Növbəti oxunuşda dəyişir?]
                                                        /            \
                                                  [BƏLİ]            [XEYR]
                                                     ↓                 ↓
                                            ┌──────────────┐  ┌─────────────────┐
                                            │ ✓ Düzəldi    │  │ ⚠ Hardware      │
                                            │   Normal     │  │   problemi      │
                                            │   işləyir    │  │   Manual        │
                                            └──────────────┘  │   yoxlama       │
                                                              └─────────────────┘
```

## 🎯 Problem Diaqnozu və Həll Yolu

```
┌─────────────────────────────────────────────────────────────────┐
│                        PROBLEM TÖVSÜKLƏRİ                       │
└─────────────────────────────────────────────────────────────────┘
                            ↓
              ┌──────────────────────────────┐
              │  ADC 632-də qalıb            │
              │  Təzyiq 0.00 göstərir        │
              └──────────────────────────────┘
                            ↓
              ┌──────────────────────────────┐
              │  ADC_RunDiagnostic()         │
              └──────────────────────────────┘
                            ↓
          [ADC 10 dəfə oxundu, dəyişir?]
                    /              \
              [BƏLİ]                [XEYR]
                 ↓                     ↓
    ┌────────────────────┐   ┌──────────────────────┐
    │  ADC Hardware OK   │   │  ADC Stuck           │
    │  Problem:          │   │  Problem:            │
    │  Kalibrasiya       │   │  1. Hardware         │
    └────────────────────┘   │  2. Continuous Mode  │
                             │  3. Sensor           │
                             └──────────────────────┘
                 ↓                     ↓
    ┌────────────────────┐   ┌──────────────────────┐
    │  Həll:             │   │  Həll:               │
    │  ADC_Force         │   │  1. Avtomatik        │
    │  Recalibration()   │   │     Restart (500)    │
    │                    │   │  2. Hardware         │
    │  ✓ Flash-a yazır   │   │     yoxlama          │
    │  ✓ Dərhal tətbiq   │   │     (PA3 pin)        │
    │                    │   │  3. Sensor test      │
    └────────────────────┘   │     (multimetr)      │
                             └──────────────────────┘
                 ↓                     ↓
    ┌────────────────────┐   ┌──────────────────────┐
    │  Yenidən Yoxla     │   │  Yenidən Yoxla       │
    └────────────────────┘   └──────────────────────┘
                 ↓                     ↓
            [Düzəldi?]            [Düzəldi?]
                /  \                  /  \
          [BƏLİ] [XEYR]         [BƏLİ] [XEYR]
             ↓      ↓               ↓      ↓
          [✓ OK] [⚠ Davam]      [✓ OK] [⚠ Hardware]
```

## 📊 Mesaj və Log Axını

```
┌─────────────────────────────────────────────────────────────────┐
│                    SERİAL MONITOR OUTPUT                        │
└─────────────────────────────────────────────────────────────────┘
                            ↓
    ┌─────────────────────────────────────────────────────┐
    │  *****************************************           │
    │  *  ADC DİAQNOSTİKA BAŞLAYIR            *           │
    │  *****************************************           │
    └─────────────────────────────────────────────────────┘
                            ↓
    ┌─────────────────────────────────────────────────────┐
    │  --- 1. ADC STATE ---                               │
    │  ADC State: 0x00000001                              │
    │    - Ready: YES                                     │
    │    - EOC Flag: SET                                  │
    └─────────────────────────────────────────────────────┘
                            ↓
    ┌─────────────────────────────────────────────────────┐
    │  --- 2. RAW ADC READINGS ---                        │
    │    Read 1: ADC = 632                                │
    │    Read 2: ADC = 632   ← Stuck!                     │
    │    ...                                              │
    └─────────────────────────────────────────────────────┘
                            ↓
              [Dəyişir?]
                /      \
          [BƏLİ]        [XEYR]
             ↓             ↓
    ┌──────────────┐  ┌────────────────────────────────┐
    │  ✓ Sistem    │  │  ⚠ PROBLEMLİ DİAQNOZ          │
    │    normal    │  │    TƏSDİQLƏNDİ                 │
    │    görünür   │  │                                 │
    └──────────────┘  │  ADC=632, Pressure=0.00        │
                      │                                 │
                      │  Recalibration tətbiq           │
                      │  olunur...                      │
                      └────────────────────────────────┘
                                     ↓
                      ┌────────────────────────────────┐
                      │  Flash operations...            │
                      │  - Sector erased                │
                      │  - Calibration restored         │
                      │  - New block written            │
                      └────────────────────────────────┘
                                     ↓
                      ┌────────────────────────────────┐
                      │  ✓ Recalibration tamamlandı    │
                      │                                 │
                      │  Yenidən yoxlama...             │
                      │  ✓ Sistem normal görünür        │
                      │    ADC=632, Pressure=1.04 bar   │
                      └────────────────────────────────┘
                                     ↓
    ┌─────────────────────────────────────────────────────┐
    │  *****************************************           │
    │  *     ADC DİAQNOSTİKA TAM              *           │
    │  *****************************************           │
    └─────────────────────────────────────────────────────┘
```

## 🔄 Stuck ADC Runtime Detection

```
Hər 10ms:
    │
    ├─→ ADC Oxu
    │
    ├─→ [Eyni dəyər?]
    │       │
    │       ├─→ [XEYR] → same_value_count = 0 → [Davam]
    │       │
    │       └─→ [BƏLİ] → same_value_count++
    │                       │
    │                       ├─→ [100?] → WARNING mesajı
    │                       ├─→ [200?] → WARNING mesajı
    │                       ├─→ [300?] → WARNING mesajı
    │                       ├─→ [400?] → WARNING mesajı
    │                       │
    │                       └─→ [500?] → CRITICAL mesajı
    │                                       │
    │                                       ├─→ ADC_Stop()
    │                                       ├─→ HAL_Delay(10)
    │                                       ├─→ ADC_Start()
    │                                       ├─→ HAL_Delay(20)
    │                                       └─→ same_value_count = 0
    │                                              │
    │                                              └─→ [✓ Restart]
    │
    └─→ [PID hesablamaları davam edir...]
```

## ✨ Xülasə Axını

```
┌──────────────────────────────────────────────────────────┐
│                   SİSTEM START                           │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│  AVTOMATIK DİAQNOSTİKA                                   │
│  ├─ ADC state yoxla                                      │
│  ├─ 10× oxuma test                                       │
│  ├─ Kalibrasiya yoxla                                    │
│  └─ Problem aşkarla                                      │
└──────────────────────────────────────────────────────────┘
                        ↓
              [Problem var?]
                /          \
          [XEYR]            [BƏLİ]
             ↓                 ↓
┌───────────────────┐  ┌────────────────────────────┐
│  ✓ Normal Start   │  │  ⚠ Düzəliş Tətbiq Olunur  │
└───────────────────┘  │  - ADC Restart (stuck)     │
                       │  - Recalibration (cal err) │
                       └────────────────────────────┘
                                  ↓
                         [✓ Düzəldi]
                                  ↓
┌──────────────────────────────────────────────────────────┐
│                    MAIN LOOP                             │
│  Hər 10ms:                                               │
│  ├─ ADC oxu                                              │
│  ├─ Stuck detection (500 eyni → restart)                │
│  ├─ PID hesabla                                          │
│  └─ PWM tətbiq et                                        │
└──────────────────────────────────────────────────────────┘
```

---

**Qeyd:** Bu flowchart sistem axınını vizual olaraq göstərir. Detallı kod və troubleshooting üçün digər sənədlərə baxın.
